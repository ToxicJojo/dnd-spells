import { readFile, writeFile, mkdirSync } from 'fs'
import { Parser } from 'xml2js'
import { Spell, SpellCollection } from '../types'

/**
 * Represents the result of parsing an xml collection file containing the data for 5e.
 * The xml files are generated by https://github.com/kinkofer/FightClub5eXML.
 */
interface XMLParseResult {
  compendium: XMLParsedCompendium;
}

/**
 * Represents a compendium that has been created from an xml by xml2js.
 */
interface XMLParsedCompendium {
  spell: Array<XMLParsedSpell>;
}

/**
 * Represents a the result of parsing a single spell from xml to a js object.
 * The parsing is done by xml2js and will generate an object with an array of values for each xml tag parsed.
 * For Most properties the array will only contain a single value.
 */
interface XMLParsedSpell {
  name: Array<string>;
  classes: Array<string>;
  level: Array<string>;
  school: Array<string>;
  ritual: Array<string>;
  time: Array<string>;
  range: Array<string>;
  components: Array<string>;
  duration: Array<string>;
  text: Array<string>;
  roll: Array<string>;
}

/**
 * Converts a spell name to an id that can be used as an object property name.
 */
const nameToId = (name: string) => {
  // Lowercase the name and replace all whitespace with a '-'.
  let id = name.toLowerCase()
  id = id.replace(/ /g, '-')
  return id
}

const spellSchoolMap = new Map<string, string>()
spellSchoolMap.set('A', 'Abjuration')
spellSchoolMap.set('C', 'Conjuration')
spellSchoolMap.set('D', 'Divination')
spellSchoolMap.set('EV', 'Evocation')
spellSchoolMap.set('EN', 'Enchantment')
spellSchoolMap.set('I', 'Illusion')
spellSchoolMap.set('N', 'Necromancy')
spellSchoolMap.set('T', 'Transmutation')

const spellLevelToString = (spellLevel: string) => {
  if (spellLevel === '0') {
    return 'Cantrip'
  } if (spellLevel === '1') {
    return '1th Level'
  } else if (spellLevel === '2') {
    return '2nd Level'
  } else if (spellLevel === '3') {
    return '3rd Level'
  } else {
    return `${Number.parseInt(spellLevel)}th Level`
  }
}

/**
 * Converts a XMLParsedSpell to an actual usable Spell object.
 * @param parsedSpell The XMLParsedSpell that will be converted.
 */
const convertSpell = (parsedSpell: XMLParsedSpell) => {
  const spell: Spell = {
    id: nameToId(parsedSpell.name[0]),
    name: parsedSpell.name[0],
    classes: parsedSpell.classes[0].split(', '),
    level: Number.parseFloat(parsedSpell.level[0]),
    levelName: spellLevelToString(parsedSpell.level[0]),
    school: spellSchoolMap.get(parsedSpell.school[0])!,
    ritual: parsedSpell.ritual[0] === 'YES',
    time: parsedSpell.time[0],
    range: parsedSpell.range[0],
    components: parsedSpell.components[0].split(', '),
    duration: parsedSpell.duration[0],
    text: parsedSpell.text[0],
    roll: parsedSpell.roll,
  }

  return spell
}

/**
 * Parses a xml file using xml2js and returns a promise that will resolve to a js object containing the data from the xml file.
 * @param xmlFilePath The file path to the xml file.
 */
const parseXMLFile = (xmlFilePath: string): Promise<XMLParseResult> => {
  return new Promise((resolve, reject) => {
    const parser = new Parser()
    readFile(`${__dirname}/${xmlFilePath}`, (_, data) => {
      parser.parseString(data, (error: any, result: XMLParseResult) => {
        if (error) {
          reject(error)
        } else {
          resolve(result)
        }
      })
    })
  })
}

/**
 * Takes an object and writes its JSON representation to a file.
 * @param fileName The name of the file to write to.
 * @param obj The object that will be used to generate the json.
 */
const objectToJsonFile = (fileName: string, obj: object) => {
  return new Promise((resolve, reject) => {
    const json = JSON.stringify(obj)
    mkdirSync(`${__dirname}/../../src/data`, { recursive: true })
    writeFile(`${__dirname}/${fileName}`, json, resolve)
  })
}

(async () => {
  console.log('Staring to create spells.json')
  const collectionFilePath = '../../data/CoreRulebooks.xml'
  const parseResult = await parseXMLFile(collectionFilePath)
  const spellList = parseResult.compendium.spell.map(convertSpell)

  // Create one SpellCollection object that has each spell a property
  const spells: SpellCollection = {}
  for (const spell of spellList) {
    spells[spell.id] = spell
  }

  await objectToJsonFile('../../src/data/spells.json', spells)
  console.log('Finished to create spells.json')
})()
